services:

  # =====================
  # PostgreSQL backend
  # =====================
  postgres:
    image: postgres:15

    # Environment variables for Postgres initialization
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    # Persist database between restarts
    volumes:
      - mlflow_pg_data:/var/lib/postgresql/data

    # Expose only to the local host
    ports:
      - "127.0.0.1:${POSTGRES_PORT}:5432"

    networks:
      - ml_platform

    restart: unless-stopped

  # =====================
  # MLflow Tracking Server
  # =====================
  mlflow:
    build:
      context: ${PROJECT_ROOT}/docker/mlflow   # where Dockerfile lives
      dockerfile: Dockerfile

    # Runtime configuration (no secrets baked into image)
    environment:
      MLFLOW_SERVER_ALLOWED_HOSTS: ${MLFLOW_SERVER_ALLOWED_HOSTS}

      MLFLOW_BACKEND_URI: ${MLFLOW_BACKEND_URI}
      MLFLOW_ARTIFACT_ROOT: ${MLFLOW_ARTIFACT_ROOT}

      # Required for boto3 (Yandex Object Storage)
      AWS_ENDPOINT_URL: ${AWS_ENDPOINT_URL}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

    # Public UI access
    ports:
      - "${MLFLOW_PORT}:5000"

    # Wait for postgres to be available
    depends_on:
      - postgres

    # Command extends ENTRYPOINT
    command:
      - server
      - --host
      - 0.0.0.0
      - --port
      - "5000"

    # Healthcheck for orchestration & future k8s readiness
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - ml_platform

    restart: unless-stopped

# =====================
# Persistent volumes
# =====================
volumes:
  mlflow_pg_data:

# =====================
# Docker network
# =====================
networks:
  ml_platform:
    driver: bridge
